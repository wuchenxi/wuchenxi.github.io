<!DOCTYPE html>
<html>
<body>
<p>
<canvas id="myCanvas" width="800" height="800"
style="border:1px solid #000000;">
</canvas>
</p>
<p>
<textarea id="code" rows="10" cols="100">
init([0, -400, 0], [0, 1, 0], [1, 0, 0], [0, 0, 1]);
color("#00FF00");
var a=20;
function x(d){
  if(d>0){f(d-1);turn(a);turn2(a);sub();sub();x(d-1);esub();turn(-a);turn2(-a),x(d-1);esub();turn(-a);f(d-1);sub();turn(-a);f(d-1);x(d-1);esub();turn(a);x(d-1);}
}
function f(d){
  if(d>0){f(d-1);f(d-1);}
  else{fwd(10);}
}
x(5);
</textarea>
</p>
<p><button type="button" onclick="drawCode();">Draw</button><button type="button" onclick="clearcvs();">Clear</button></p>
<p>The drawing region is [-400, 400] in all three directions.</p>
<p>At each state there are 3 axis, a1, s2 and a3, which should be kept orthogonal to each other </p>
<p>fwd(20): move along a1 axis for 20 units.</p>
<p>turn(30): turn 30 degrees towards a2 axis. </p>
<p>turn2(20): rotate a2 and a3 axis by 20 degrees </p>
<p>sub(): remember the current location and directions. </p>
<p>esub(): use the previously remembered location and directions. </p>
<p>init(starting_point, a1, a2, a3): set starting point and directions</p>
<p>color("#00FF00"): set color to green</p>
<script>
  var doAnim=false;
  function clearcvs(){
      doAnim=false;
      var cvs=document.getElementById("myCanvas");
      var ctx=cvs.getContext("2d");
      ctx.clearRect(0, 0, cvs.width, cvs.height);
  }
  function drawCode(){
      let pic={
	  cur: [0,0,0],	
	  a1: [0, 1, 0],
	  a2: [1, 0, 0],
	  a3: [0, 0, 1],
	  stack: [],
	  r: [],
	  init: function(pt, a1, a2, a3){
	      pic.cur=pt;
	      pic.a1=a1;
	      pic.a2=a2;
	      pic.a3=a3;
	  },
	  fwd: function(d){
	      var next=pic.cur.map((x, i)=>x+pic.a1[i]*d);
	      pic.r.push([pic.cur, next]);
	      pic.cur=next;
	  },
	  turn : function(d){
	      var a=d*Math.PI/180;
	      var s=Math.sin(a);
	      var c=Math.cos(a);
	      var na1=pic.a1.map((x, i)=>c*x+s*pic.a2[i]);
	      var na2=pic.a2.map((x, i)=>c*x-s*pic.a1[i]);
	      pic.a1=na1;
	      pic.a2=na2;
	  },
	  turn2 : function(d){
	      var a=d*Math.PI/180;
	      var s=Math.sin(a);
	      var c=Math.cos(a);
	      var na2=pic.a2.map((x, i)=>c*x+s*pic.a3[i]);
	      var na3=pic.a3.map((x, i)=>c*x-s*pic.a2[i]);
	      pic.a2=na2;
	      pic.a3=na3;
	  },
	  sub : function(){
	      pic.stack.push([pic.cur, pic.a1, pic.a2, pic.a3]);
	  },
	  esub : function(){
	      var v=pic.stack.pop();
	      pic.cur=v[0];
	      pic.a1=v[1];
	      pic.a2=v[2];
	      pic.a3=v[3];
	  },
	  color : function(s){
	      pic.r.push([s]);
	  }
      };
      var inputVal=document.getElementById("code").value;
      Function('"use strict"; return(function(init, fwd, turn, turn2, sub, esub, color){'+inputVal+'})')()(
	  pic.init, pic.fwd, pic.turn, pic.turn2, pic.sub, pic.esub, pic.color
      );
      function perspective(v, c, s){
	  var nv=[c*v[0]-s*v[2], v[1], s*v[0]+c*v[2]];
	  return [400+nv[0]*400/(800-nv[2]), 400-nv[1]*400/(800-nv[2])];
      }
      doAnim=true;
      function draw_frame(){
         var cvs=document.getElementById("myCanvas");
          var ctx=cvs.getContext("2d");
	  ctx.beginPath();
	  ctx.clearRect(0, 0, cvs.width, cvs.height);
	  var time=new Date();
	  var r=0.1*time.getSeconds()+0.0001*time.getMilliseconds();
          var c=Math.cos(r);
	  var s=Math.sin(r);
          for(var l of pic.r){
	     if(l.length==1){
	       ctx.strokeStyle=l[0];
	   }
	  else{
	      var p1=perspective(l[0], c, s);
	      var p2=perspective(l[1], c, s);
	      ctx.moveTo(p1[0], p1[1]);
	      ctx.lineTo(p2[0], p2[1]);
	      ctx.stroke();
	  }
	  }
	  if(doAnim)
	        window.requestAnimationFrame(draw_frame);

      }
      window.requestAnimationFrame(draw_frame);
 }
</script>

</body>
</html>
